# Домашнее задание к занятию "Мониторинг состояния БД"


### Цель задания

В результате выполнения этого задания вы:

1. получите практику работы с настройкой параметров логирования под конкретные параметры эксплуатации сервера в живой системе и научитесь ориентироваться в других возможностях данной процедуры;
2. научитесь включать мониторинг долгих запросов в целях выявления проблемных участков нагрузки на сервере;
3. отработаете операцию прерывания вредоносного-ненужного запроса или сессии, что позволит вмешиваться точечно в формируемую нагрузку на сервере БД;
4. получитите навык мониторинга лидирующих запросов исполняемых на сервере, сортируя по различным параметрам производительности, что бывает полезно в практической работе для анализа состава нагрузки в БД и на что или кем расходуется ресурс сервера.

------

### Чеклист готовности к домашнему заданию

1. Создать БД PostgreSQL для выполнения заданий.

------

### Задание 1

1. Требуется изменить наименование файла-журнала БД на формат имени postgres-XXX, где ХХХ - день недели и включить ротирование файлов, так чтобы постоянно оставалось 7 файлов на каждый день недели.
2. Необходимо включить запись событий подключения сессии пользователя и запись запроса, который выполняется больше 1 сек.
3. Воспользовавшись представлением статистики, необходимо увидеть и определить время подключения сессии, под которой вы сейчас работаете, её текущеее состояние и тип сессии `backend_type`.
4. Во 2-ом терминале подключения к БД, выполнить команду отключения сеанса 1-го терминала.
5. Определить ТОП-1 самых часто запускаемый запрос.

------

## Дополнительные задания (со звездочкой*)
Эти задания дополнительные (не обязательные к выполнению) и никак не повлияют на получение вами зачета по этому домашнему заданию. Вы можете их выполнить, если хотите глубже и/или шире разобраться в материале.


------

### Задание 2*

1. Требуется изменить ротирование файла-журнала так, чтобы файл достигал размера до 500МБ, при превышении становился архивом, а на его место создавался новый пустой файл.
2. Необходимо включить запись события отключения сессии пользователя и запись всех выполняемых DML операций.
3. Воспользовавшись представлением статистики необходимо увидеть и определить продолжительность (сколько прошло времени на текущий момент со времени подключения к БД) работы вашеей сессий, под которой вы сейчас работаете, ее текущеее состояние и тип сессии `backend_type`.
4. В 1-ом терминале выполнить начало транзакции `begin transaction;`.  
Какую команду нужно выполнить во 2-ом терминале подключения к БД, чтобы прервать работу сессии в 1-ом терминале и подойдет ли для этого команда `pg_cancel_backend()`?
5. Оперделить ТОП-1 из самых затратных по процессорным ресурсам запросов (приведите команду SQL и вывод команды)
6. Посмотреть статистику работы процесса checkpoint и дать оценку: на сколько эффективно он работает, что стоит изменить?
7. Посмотреть план выполнения запроса `explain select count(*) from table;`.  
Какую стоимость ставит планировщик для чтения таблицы?

------

## Задание 3*

Посмотреть статистику по количеству строк и блоков у таблицы (содержащую 5-10 тыс строк), выполнить встравку/удаление 1-2 строк и добиться того, чтобы статистика показала это увеличение.

1. в 1-ом терминале
    - выполнить вставку в таблицу, выполнить `COMMIT`
    - начать транзакцию `BEGIN TRANSACTION`
    - выполнить UPDATE вставленной записи, не выполняя `COMMIT` или `ROLLBACK`
2. во 2-ом терминале
    - начать транзакцию `BEGIN TRANSACTION`
    - выполнить `UPDATE` той же строки

Что наблюдаем при выполнении команды ?
В представлении pg_stat_activity нужно увидеть статус сессии 1-го и 2-го терминала, какие wait_event, wait_event_type?


------


### Правила приема работы

В личном кабинете отправлена ссылка на документ (Google Doc) с выполненным заданием. В документе настроены права доступа “Просматривать могут все в Интернете, у кого есть ссылка”.

1. Приложить скриншоты результат выполнения работы  
2. Показать, какая команда или настройка (возможно последовательность или список действий) была выполнена.

------

### Критерии оценки

Зачет - выполнены задания без звездочки, ответы даны в развернутой форме, приложены соответствующие скриншоты и файлы проекта, в выполненных заданиях нет противоречий и нарушения логики.

На доработку - задание выполнено частично или не выполнено, в логике выполнения заданий есть противоречия, существенные недостатки.
